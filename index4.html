<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エルデソリソグ ナイトレイソ～深き夜のリブラ～(人形ちゃんver.)</title>
    <style>
        body {
            background-color: yellow;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            flex-direction: column;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        #gameCanvas {
            background-color: #EDC9AF; /* 砂漠色 */
            border: 2px solid black;
        }
        #gameTitle {
            font-family: Arial, sans-serif;
            font-size: 20px;
            color: black;
            text-align: center;
            margin-bottom: 10px;
        }
        #animationCanvas {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="gameTitle">エルデソリソグ ナイトレイソ～深き夜のリブラ～(人形ちゃんソロver.)</div>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="600" height="600"></canvas>
        <canvas id="animationCanvas" width="600" height="100"></canvas>
    </div>
    <script>
        const gameCanvas = document.getElementById('gameCanvas');
        const gameCtx = gameCanvas.getContext('2d');
        const animationCanvas = document.getElementById('animationCanvas');
        const animationCtx = animationCanvas.getContext('2d');

        // 設定値
        const CONFIG = {
            playerSpeed: 5,
            haloSpeed: 7,
            haloFrequency: 500, // ミリ秒
            haloSize: 10,
            libraWarpFrequency: 2000, // ミリ秒
            libraMadnessAttackFrequency: 600, // 頻度5倍
            libraSummonAttackFrequency: 5000, // ミリ秒
            madnessAttackSpeed: 3,
            summonAttackSpeed: 6, // 速度2倍
            summonTrackingStrength: 0.05,
            madnessAttackSize: 15, // 表示サイズ
            summonAttackSize: 20, // 絵文字の表示サイズ
            summonAttackCollisionSize: 10, // 召喚攻撃の当たり判定サイズ
            bgmVolume: 0.5, // BGM音量
        };

        // ゲーム状態
        let gameState = 'title';
        let titlePhase = 'doll'; // 'doll'（人形ちゃん説明）, 'halo'（光輪説明）, 'choice'（メイク・ユア・チョイス）
        let player = { x: gameCanvas.width / 2, y: gameCanvas.height - 50, level: 13, hp: 10, fp: 100, stamina: 11, size: 20 };
        let libra = { x: gameCanvas.width / 2, y: 100, hp: 70, size: 60 }; // デフォルトHPを70に
        let halos = [];
        let madnessAttacks = [];
        let summonAttacks = [];
        let coins = [];
        let madnessGauge = 0;
        let choiceSelected = null;
        let lastHaloTime = 0;
        let lastWarpTime = 0;
        let lastMadnessAttackTime = 0;
        let lastSummonAttackTime = 0;

        // アニメーション状態
        let animationOffset = 0;
        const animationSpeed = 0.05;
        const animationAmplitude = 20;

        // 音声
        const makeYourChoiceSound = new Audio('make_your_choice.mp3');
        const libraBgm = new Audio('libra_bgm.mp3');
        libraBgm.loop = true;
        libraBgm.volume = CONFIG.bgmVolume;
        const damageBgm = new Audio('damage_bgm.mp3');

        // 入力処理
        let mouseX = gameCanvas.width / 2;
        let mouseY = gameCanvas.height - 50;
        let keys = {};
        gameCanvas.addEventListener('mousemove', (e) => {
            const rect = gameCanvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });
        gameCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const rect = gameCanvas.getBoundingClientRect();
            mouseX = e.touches[0].clientX - rect.left;
            mouseY = e.touches[0].clientY - rect.top;
        }, { passive: false });
        gameCanvas.addEventListener('click', handleClick);
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            if (e.key === 'Enter' && gameState === 'title') handleClick();
        });
        document.addEventListener('keyup', (e) => { keys[e.key] = false; });

        function handleClick() {
            if (gameState === 'title') {
                if (titlePhase === 'doll') {
                    titlePhase = 'halo';
                } else if (titlePhase === 'halo') {
                    titlePhase = 'choice';
                } else if (titlePhase === 'choice') {
                    makeYourChoiceSound.play();
                    gameState = 'choice';
                }
            } else if (gameState === 'choice') {
                const choiceY = [200, 250, 300, 350];
                for (let i = 0; i < 4; i++) {
                    if (mouseY >= choiceY[i] - 20 && mouseY <= choiceY[i] + 20) {
                        choiceSelected = i + 1;
                        applyChoice();
                        gameState = 'playing';
                        libraBgm.play();
                    }
                }
            } else if (gameState === 'gameover') {
                if (mouseX >= gameCanvas.width / 2 - 50 && mouseX <= gameCanvas.width / 2 + 50 &&
                    mouseY >= 400 - 20 && mouseY <= 400 + 20) {
                    resetGame();
                }
            }
        }

        function applyChoice() {
            if (choiceSelected === 1) {
                player.level = 15;
            } else if (choiceSelected === 2) {
                player.stamina = 9;
            } else if (choiceSelected === 3) {
                player.size *= 1.5;
                libra.size *= 1.5;
                player.hp = 15;
                player.fp = 150;
                player.stamina = 16.5;
                libra.hp = 105; // 選択肢3でリブラHPを105に
            }
        }

        function resetGame() {
            player = { x: gameCanvas.width / 2, y: gameCanvas.height - 50, level: 13, hp: 10, fp: 100, stamina: 11, size: 20 };
            libra = { x: gameCanvas.width / 2, y: 100, hp: 70, size: 60 }; // リセット時HPを70に
            halos = [];
            madnessAttacks = [];
            summonAttacks = [];
            coins = [];
            madnessGauge = 0;
            choiceSelected = null;
            gameState = 'title';
            titlePhase = 'doll';
            libraBgm.play();
        }

        function update() {
            if (gameState !== 'playing') return;

            // プレイヤー移動
            if (keys['ArrowLeft']) player.x -= CONFIG.playerSpeed;
            if (keys['ArrowRight']) player.x += CONFIG.playerSpeed;
            if (keys['ArrowUp']) player.y -= CONFIG.playerSpeed;
            if (keys['ArrowDown']) player.y += CONFIG.playerSpeed;
            player.x = Math.max(player.size, Math.min(gameCanvas.width - player.size, mouseX));
            player.y = Math.max(player.size, Math.min(gameCanvas.height - player.size, mouseY));

            // 光輪発射
            if (Date.now() - lastHaloTime > CONFIG.haloFrequency) {
                halos.push({ x: player.x, y: player.y - player.size, size: CONFIG.haloSize });
                lastHaloTime = Date.now();
            }
            halos.forEach(halo => {
                halo.y -= CONFIG.haloSpeed;
            });
            halos = halos.filter(halo => halo.y > -halo.size);

            // リブラのワープ
            if (Date.now() - lastWarpTime > CONFIG.libraWarpFrequency) {
                libra.x = Math.random() * (gameCanvas.width - libra.size * 2) + libra.size;
                libra.y = Math.random() * (gameCanvas.height / 2 - libra.size * 2) + libra.size;
                lastWarpTime = Date.now();
            }

            // 発狂攻撃
            if (Date.now() - lastMadnessAttackTime > CONFIG.libraMadnessAttackFrequency) {
                madnessAttacks.push({ x: libra.x, y: libra.y, size: CONFIG.madnessAttackSize, dx: Math.random() * 2 - 1, dy: CONFIG.madnessAttackSpeed });
                lastMadnessAttackTime = Date.now();
            }
            madnessAttacks.forEach(attack => {
                attack.x += attack.dx;
                attack.y += attack.dy;
            });
            madnessAttacks = madnessAttacks.filter(attack => attack.y < gameCanvas.height + attack.size);

            // 召喚攻撃
            if (Date.now() - lastSummonAttackTime > CONFIG.libraSummonAttackFrequency) {
                summonAttacks.push({ x: libra.x, y: libra.y, size: CONFIG.summonAttackCollisionSize, hits: 0 });
                lastSummonAttackTime = Date.now();
            }
            summonAttacks.forEach(attack => {
                const dx = player.x - attack.x;
                const dy = player.y - attack.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 0) {
                    attack.x += (dx / dist) * CONFIG.summonAttackSpeed * CONFIG.summonTrackingStrength;
                    attack.y += (dy / dist) * CONFIG.summonAttackSpeed * CONFIG.summonTrackingStrength;
                }
            });

            // 衝突判定
            halos.forEach(halo => {
                const libraCollisionSize = choiceSelected === 3 ? libra.size / 4 * 1.5 : libra.size / 4;
                if (Math.hypot((halo.x - libra.x) * 1.2, halo.y - libra.y) < halo.size + libraCollisionSize) {
                    libra.hp--;
                    halo.y = -halo.size;
                    if (libra.hp <= 0) {
                        gameState = 'win';
                        libraBgm.pause();
                    }
                }
                summonAttacks.forEach(attack => {
                    if (Math.hypot(halo.x - attack.x, halo.y - attack.y) < halo.size + attack.size / 2) {
                        attack.hits++;
                        halo.y = -halo.size;
                        if (attack.hits >= 2) {
                            coins.push({ x: attack.x, y: attack.y });
                            attack.y = gameCanvas.height + attack.size;
                        }
                    }
                });
            });

            madnessAttacks.forEach(attack => {
                if (Math.hypot(attack.x - player.x, attack.y - player.y) < attack.size / 5 + player.size) {
                    madnessGauge += 0.1;
                    attack.y = gameCanvas.height + attack.size;
                    if (madnessGauge >= (choiceSelected === 2 ? 1.5 : 1)) {
                        player.hp = 0;
                        gameState = 'gameover';
                    }
                }
            });

            summonAttacks.forEach(attack => {
                if (Math.hypot(attack.x - player.x, attack.y - player.y) < attack.size / 2 + player.size) {
                    player.hp -= 0.1;
                    damageBgm.play();
                    if (player.hp <= 0) {
                        gameState = 'gameover';
                    }
                }
            });

            coins.forEach(coin => {
                if (Math.hypot(coin.x - player.x, coin.y - player.y) < 10 + player.size) {
                    player.hp = Math.min(player.hp + 1, choiceSelected === 3 ? 15 : 10);
                    madnessGauge = Math.max(madnessGauge - 0.2, 0);
                    coin.y = gameCanvas.height + 10;
                }
            });
            coins = coins.filter(coin => coin.y < gameCanvas.height);

            // アニメーション更新
            animationOffset += animationSpeed;
        }

        function draw() {
            // ゲーム画面
            gameCtx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            if (gameState === 'title') {
                gameCtx.fillStyle = 'black';
                gameCtx.font = '20px Arial';
                gameCtx.textAlign = 'center';
                if (titlePhase === 'doll') {
                    gameCtx.fillText('💀: 人形ちゃん', gameCanvas.width / 2, 200);
                    gameCtx.fillText('スキルとアーツとエスト瓶とアイテム、', gameCanvas.width / 2, 240);
                    gameCtx.fillText('その他もろもろは深度5なので', gameCanvas.width / 2, 260);
                    gameCtx.fillText('使えません。', gameCanvas.width / 2, 280);
                } else if (titlePhase === 'halo') {
                    gameCtx.fillText('🌀: 光輪', gameCanvas.width / 2, 200);
                    gameCtx.fillText('夜に侵され変質しているので', gameCanvas.width / 2, 240);
                    gameCtx.fillText('投げっ放しです。戻って来ません。', gameCanvas.width / 2, 260);
                    gameCtx.fillText('色も青いです。', gameCanvas.width / 2, 280);
                } else if (titlePhase === 'choice') {
                    gameCtx.font = '30px Arial';
                    gameCtx.fillText('メイク・ユア・チョイス', gameCanvas.width / 2, gameCanvas.height / 2);
                }
                gameCtx.textAlign = 'left';
            } else if (gameState === 'choice') {
                gameCtx.fillStyle = 'black';
                gameCtx.font = '20px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('飛躍的にレベルアップしたい', gameCanvas.width / 2, 200);
                gameCtx.fillText('状態異常に強くなりたい', gameCanvas.width / 2, 250);
                gameCtx.fillText('全力で戦いたい', gameCanvas.width / 2, 300);
                gameCtx.fillText('取引はしない', gameCanvas.width / 2, 350);
                gameCtx.fillStyle = 'black';
                gameCtx.font = '20px Arial';
                gameCtx.fillText('🧥', gameCanvas.width / 2, gameCanvas.height / 2 - 150);
                gameCtx.textAlign = 'left';
            } else if (gameState === 'playing') {
                // ゲージ（プレイヤー）
                gameCtx.fillStyle = 'black';
                gameCtx.font = '20px Arial';
                gameCtx.fillText(player.level === 15 ? '⑮' : '⑬', 10, 60);
                gameCtx.fillStyle = 'red';
                gameCtx.fillRect(50, 40, player.hp * 15, 10);
                gameCtx.fillStyle = 'blue';
                gameCtx.fillRect(50, 60, player.fp * (gameCanvas.width - 50) / 100, 10);
                gameCtx.fillStyle = 'green';
                gameCtx.fillRect(50, 80, player.stamina * 15, 10);
                if (madnessGauge > 0) {
                    gameCtx.fillStyle = 'rgba(255, 255, 0, 0.5)';
                    gameCtx.fillRect(gameCanvas.width / 2 - 75, gameCanvas.height / 2 - 10, madnessGauge * 150, 20);
                }

                // リブラのHPゲージ
                gameCtx.fillStyle = 'red';
                const maxHp = choiceSelected === 3 ? 105 : 70;
                gameCtx.fillRect((gameCanvas.width - 480) / 2, gameCanvas.height - 30, 480 * (libra.hp / maxHp), 5);

                // プレイヤー
                gameCtx.fillStyle = 'black';
                gameCtx.font = `${player.size}px Arial`;
                gameCtx.fillText('💀', player.x - player.size / 2, player.y);
                
                // リブラ
                gameCtx.fillStyle = 'black';
                gameCtx.font = `${libra.size}px Arial`;
                gameCtx.fillText('🐐', libra.x - libra.size / 2, libra.y);
                
                // 光輪
                gameCtx.fillStyle = 'blue';
                gameCtx.font = `${CONFIG.haloSize}px Arial`;
                halos.forEach(halo => {
                    gameCtx.fillText('🌀', halo.x - halo.size / 2, halo.y);
                });
                
                // 発狂攻撃
                gameCtx.fillStyle = 'purple';
                gameCtx.font = `${CONFIG.madnessAttackSize}px Arial`;
                madnessAttacks.forEach(attack => {
                    gameCtx.fillText('👁', attack.x - attack.size / 2, attack.y);
                });
                
                // 召喚攻撃
                gameCtx.fillStyle = 'gray';
                gameCtx.font = `${CONFIG.summonAttackSize}px Arial`;
                summonAttacks.forEach(attack => {
                    gameCtx.fillText('👤', attack.x - attack.size / 2, attack.y);
                });
                
                // コイン
                gameCtx.fillStyle = 'gold';
                gameCtx.font = '20px Arial';
                coins.forEach(coin => {
                    gameCtx.fillText('💰', coin.x - 10, coin.y);
                });
            } else if (gameState === 'gameover') {
                gameCtx.fillStyle = 'red';
                gameCtx.font = '40px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('ユー・ダイド', gameCanvas.width / 2, gameCanvas.height / 2);
                gameCtx.fillStyle = 'black';
                gameCtx.font = '20px Arial';
                gameCtx.fillText('リスタート', gameCanvas.width / 2, 400);
                gameCtx.textAlign = 'left';
            } else if (gameState === 'win') {
                gameCtx.fillStyle = 'white';
                gameCtx.font = '40px Arial';
                gameCtx.textAlign = 'center';
                gameCtx.fillText('ナイトロード・フェルド', gameCanvas.width / 2, gameCanvas.height / 2);
                gameCtx.textAlign = 'left';
            }

            // アニメーション描画
            animationCtx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
            animationCtx.fillStyle = 'black';
            const characters = [
                { name: 'ヘレン', x: animationCanvas.width / 4 },
                { name: 'フレデリック', x: animationCanvas.width / 2 },
                { name: 'セバスチャン', x: 3 * animationCanvas.width / 4 },
            ];
            characters.forEach(char => {
                animationCtx.font = '30px Arial';
                const offsetX = Math.sin(animationOffset) * animationAmplitude;
                animationCtx.fillText('💀', char.x - 15 + offsetX, 40);
                animationCtx.font = '8px Arial';
                animationCtx.textAlign = 'center';
                animationCtx.fillText(char.name, char.x + offsetX, 70);
            });
            animationCtx.textAlign = 'left';
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>